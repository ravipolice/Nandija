(()=>{var e={};e.id=438,e.ids=[438],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},14985:e=>{"use strict";e.exports=require("dns")},19771:e=>{"use strict";e.exports=require("process")},19932:(e,o,r)=>{"use strict";r.r(o),r.d(o,{patchFetch:()=>D,routeModule:()=>v,serverHooks:()=>h,workAsyncStorage:()=>y,workUnitAsyncStorage:()=>S});var t={};r.r(t),r.d(t,{POST:()=>A,dynamic:()=>p});var s=r(96559),i=r(48088),a=r(37719),n=r(32190),c=r(33873),l=r.n(c),d=r(29021),u=r.n(d);let p="force-dynamic",m=!1,g=null,f=null;function b(){try{let e;let{initializeApp:o,getApps:t}=r(602);return e=t().length?t()[0]:o({apiKey:"AIzaSyB_d5ueTul9vKeNw3pmEtCmbF9w1BVkrAQ",authDomain:"pmd-police-mobile-directory.firebaseapp.com",projectId:"pmd-police-mobile-directory",storageBucket:"pmd-police-mobile-directory.firebasestorage.app"}),console.log("âœ… Firebase Client SDK initialized as fallback"),{success:!0,app:e}}catch(e){return console.error("âŒ Failed to initialize Firebase:",e.message),{success:!1,error:e.message}}}async function A(e){console.log("\uD83D\uDCE5 Documents Firebase Upload API: Request received");try{let o,t;let{title:s,fileBase64:i,mimeType:a,category:c,description:d,userEmail:p}=await e.json();if(!i)return n.NextResponse.json({success:!1,error:"Missing required field: fileBase64"},{status:400});console.log("\uD83D\uDCE5 Upload request:",{title:s||"Untitled",mimeType:a,fileSize:i?`${(3*i.length/4/1024).toFixed(2)} KB`:"unknown"});try{o=Buffer.from(i,"base64")}catch(e){return n.NextResponse.json({success:!1,error:"Invalid base64 file data"},{status:400})}if(o.length>0xa00000)return n.NextResponse.json({success:!1,error:"File too large (max 10MB)"},{status:400});let A=a||"application/octet-stream",v="bin";if(A.includes("pdf"))v="pdf";else if(A.includes("word")||A.includes("document"))v="docx";else if(A.includes("excel")||A.includes("spreadsheet"))v="xlsx";else if(A.includes("powerpoint")||A.includes("presentation"))v="pptx";else if(A.includes("image"))v=A.includes("png")?"png":A.includes("jpeg")||A.includes("jpg")?"jpg":"img";else{let e=A.match(/\/([a-z0-9]+)$/);e&&(v=e[1])}let y=`${Date.now()}_${Math.random().toString(36).substring(2,9)}`,S=`documents/${y}.${v}`,h=function(){if(m)return{success:!0,storage:g,firestore:f};try{let e=r(46675);if(e.apps.length)return m=!0,g=e.storage(),f=e.firestore(),console.log("âœ… Firebase Admin SDK already initialized"),{success:!0,storage:g,firestore:f};try{if(process.env.GOOGLE_APPLICATION_CREDENTIALS){let o=l().isAbsolute(process.env.GOOGLE_APPLICATION_CREDENTIALS)?process.env.GOOGLE_APPLICATION_CREDENTIALS:l().resolve(process.cwd(),process.env.GOOGLE_APPLICATION_CREDENTIALS);if(console.log("\uD83D\uDCC1 Loading service account from:",o),console.log("\uD83D\uDCC1 Current working directory:",process.cwd()),console.log("\uD83D\uDCC1 GOOGLE_APPLICATION_CREDENTIALS:",process.env.GOOGLE_APPLICATION_CREDENTIALS),!u().existsSync(o))throw Error(`Service account file not found at: ${o}`);let r=u().readFileSync(o,"utf8"),t=JSON.parse(r);console.log("\uD83D\uDCE7 Service account email:",t.client_email),console.log("\uD83D\uDCCB Project ID:",t.project_id),e.initializeApp({credential:e.credential.cert(t),storageBucket:"pmd-police-mobile-directory.firebasestorage.app",projectId:"pmd-police-mobile-directory"})}else console.log("âš ï¸ GOOGLE_APPLICATION_CREDENTIALS not set, trying default credentials"),e.initializeApp({storageBucket:"pmd-police-mobile-directory.firebasestorage.app",projectId:"pmd-police-mobile-directory"});return m=!0,g=e.storage(),f=e.firestore(),console.log("âœ… Firebase Admin SDK initialized successfully"),{success:!0,storage:g,firestore:f}}catch(e){return console.warn("âš ï¸ Firebase Admin SDK initialization failed:",e.message),console.warn("âš ï¸ Error code:",e.code),"app/no-app"===e.code&&(console.warn("âš ï¸ This usually means Admin SDK credentials are missing."),console.warn("âš ï¸ For local development, set GOOGLE_APPLICATION_CREDENTIALS env var"),console.warn("âš ï¸ Or use 'gcloud auth application-default login' for ADC")),{success:!1,error:e.message}}}catch(e){return console.warn("âš ï¸ Firebase Admin SDK not available:",e.message),{success:!1,error:e.message}}}();if(h.success&&h.storage)try{console.log("\uD83D\uDCE4 Uploading via Firebase Admin SDK to:",S);let e="pmd-police-mobile-directory.firebasestorage.app";console.log("\uD83D\uDCE6 Using bucket:",e);let r=h.storage.bucket(e);console.log("\uD83D\uDCE6 Bucket object created, attempting to verify access...");try{let[o]=await Promise.race([r.exists(),new Promise((e,o)=>setTimeout(()=>o(Error("Bucket check timeout")),5e3))]);o?console.log("âœ… Bucket verified and accessible:",e):console.warn("âš ï¸ Bucket exists check returned false, but continuing with upload attempt...")}catch(e){console.warn("âš ï¸ Bucket check failed (may be permissions propagation delay):",e.message),console.warn("âš ï¸ Continuing with upload attempt anyway...")}let i=r.file(S);await i.save(o,{metadata:{contentType:A,metadata:{uploadedBy:p||"admin@pmd.com",title:s||"Untitled"}},public:!0}),t=`https://storage.googleapis.com/${r.name}/${S}`,console.log("âœ… Admin SDK upload successful:",t)}catch(e){if(console.error("âŒ Admin SDK upload failed:",e),e.response?.data?.error?.code===404){let o=e.response.data.error.message||e.message;throw Error(`Bucket not found or service account lacks permissions: ${o}

ðŸ’¡ To fix:
1. Go to Firebase Console â†’ Project Settings â†’ Service Accounts
2. Ensure the service account has "Storage Admin" or "Storage Object Admin" role
3. Or go to Google Cloud Console â†’ IAM & Admin â†’ IAM
4. Find the service account email and grant Storage permissions`)}throw Error(`Admin SDK upload failed: ${e.message}`)}else{let e=b();if(e.success&&e.app)try{console.log("\uD83D\uDCE4 Uploading via Firebase Client SDK to:",S);let{getStorage:i,ref:a,uploadBytes:n,getDownloadURL:c}=r(91084),l=i(e.app),d=a(l,S),u=new Uint8Array(o);await n(d,u,{contentType:A,customMetadata:{uploadedBy:p||"admin@pmd.com",title:s||"Untitled"}}),t=await c(d),console.log("âœ… Client SDK upload successful:",t)}catch(o){console.error("âŒ Client SDK upload failed:",o),console.error("âŒ Error code:",o.code),console.error("âŒ Error message:",o.message),console.error("âŒ Error serverResponse:",o.serverResponse),console.error("âŒ Full error:",JSON.stringify(o,Object.getOwnPropertyNames(o),2));let e=`Upload failed: ${o.message||o.code||"Unknown error"}`;throw("storage/unauthorized"===o.code||"storage/unknown"===o.code)&&(e+="\n\n\uD83D\uDCA1 This might be due to Firebase Storage security rules. Please check your Firebase Console > Storage > Rules to ensure uploads to 'documents/*' are allowed."),Error(e)}else throw Error(`Firebase initialization failed: ${e.error||"Unknown error"}`)}console.log("\uD83D\uDCBE Attempting to save document metadata to Firestore..."),console.log("\uD83D\uDCBE Document ID:",y),console.log("\uD83D\uDCBE Collection: documents");try{if(h.success&&h.firestore){console.log("\uD83D\uDCBE Using Admin SDK Firestore...");let e=r(46675),o=new Date,i={title:s||"Untitled",url:t,URL:t,category:c||void 0,description:d||void 0,uploadedBy:p||"admin@pmd.com",createdAt:e.firestore.Timestamp.fromDate(o),updatedAt:e.firestore.Timestamp.fromDate(o),storagePath:S,fileType:A};console.log("\uD83D\uDCBE Document data to save:",JSON.stringify(i,null,2)),await h.firestore.collection("documents").doc(y).set(i),console.log("âœ… Firestore metadata saved via Admin SDK"),console.log("âœ… Document saved to: documents/"+y)}else{console.log("\uD83D\uDCBE Admin SDK not available, trying Client SDK Firestore...");let e=b();if(e.success&&e.app){let{getFirestore:o,doc:i,setDoc:a,Timestamp:n}=r(77724),l=o(e.app),u=n.now(),m={title:s||"Untitled",url:t,URL:t,category:c||void 0,description:d||void 0,uploadedBy:p||"admin@pmd.com",createdAt:u,updatedAt:u,storagePath:S,fileType:A};console.log("\uD83D\uDCBE Document data to save:",JSON.stringify(m,null,2)),await a(i(l,"documents",y),m),console.log("âœ… Firestore metadata saved via Client SDK"),console.log("âœ… Document saved to: documents/"+y)}else console.error("âŒ Both Admin SDK and Client SDK Firestore failed to initialize")}}catch(e){console.error("âŒ Failed to save to Firestore:",e.message),console.error("âŒ Error code:",e.code),console.error("âŒ Error stack:",e.stack)}return console.log("âœ… Documents Firebase Upload: Successfully uploaded:",s||"Untitled"),console.log("âœ… Documents Firebase Upload: Download URL:",t),console.log("âœ… Documents Firebase Upload: File ID:",y),console.log("âœ… Documents Firebase Upload: Storage Path:",S),n.NextResponse.json({success:!0,url:t,imageUrl:t,title:s||"Untitled",uploader:p||"admin@pmd.com",fileId:y,storagePath:S})}catch(r){console.error("Documents Firebase Upload: Error uploading document:",r),console.error("Documents Firebase Upload: Error stack:",r.stack);let e=r.message||"Failed to upload document",o="";return r.message?.includes("Admin SDK")?o="\n\n\uD83D\uDCA1 To fix this:\n1. Download Firebase service account key from Firebase Console\n2. Set GOOGLE_APPLICATION_CREDENTIALS env variable\n3. Restart dev server":r.message?.includes("Client SDK")||"storage/unknown"===r.code||"storage/unauthorized"===r.code?o="\n\n\uD83D\uDCA1 This is likely due to Firebase Storage security rules.\n\nOption 1 (Recommended): Set up Firebase Admin SDK with service account credentials\nOption 2 (Development only): Update Firebase Storage rules to allow uploads":r.message?.includes("Firebase not initialized")&&(o="\n\n\uD83D\uDCA1 Firebase initialization failed. Check server console for details."),n.NextResponse.json({success:!1,error:e+o,errorCode:r.code||"unknown",details:void 0},{status:500})}}let v=new s.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/documents/upload-firebase/route",pathname:"/api/documents/upload-firebase",filename:"route",bundlePath:"app/api/documents/upload-firebase/route"},resolvedPagePath:"C:\\Users\\ravip\\AndroidStudioProjects\\pmd-admin\\app\\api\\documents\\upload-firebase\\route.ts",nextConfigOutput:"",userland:t}),{workAsyncStorage:y,workUnitAsyncStorage:S,serverHooks:h}=v;function D(){return(0,a.patchFetch)({workAsyncStorage:y,workUnitAsyncStorage:S})}},21820:e=>{"use strict";e.exports=require("os")},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29021:e=>{"use strict";e.exports=require("fs")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:e=>{"use strict";e.exports=require("path")},34631:e=>{"use strict";e.exports=require("tls")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},46675:e=>{"use strict";e.exports=require("firebase-admin")},55511:e=>{"use strict";e.exports=require("crypto")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},73496:e=>{"use strict";e.exports=require("http2")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{}};var o=require("../../../../webpack-runtime.js");o.C(e);var r=e=>o(o.s=e),t=o.X(0,[447,580,316],()=>r(19932));module.exports=t})();