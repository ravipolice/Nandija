(()=>{var e={};e.id=774,e.ids=[774],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},14985:e=>{"use strict";e.exports=require("dns")},19771:e=>{"use strict";e.exports=require("process")},21820:e=>{"use strict";e.exports=require("os")},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29021:e=>{"use strict";e.exports=require("fs")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:e=>{"use strict";e.exports=require("path")},34631:e=>{"use strict";e.exports=require("tls")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},46675:e=>{"use strict";e.exports=require("firebase-admin")},55511:e=>{"use strict";e.exports=require("crypto")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},73496:e=>{"use strict";e.exports=require("http2")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},91645:e=>{"use strict";e.exports=require("net")},94536:(e,r,t)=>{"use strict";t.r(r),t.d(r,{patchFetch:()=>S,routeModule:()=>A,serverHooks:()=>h,workAsyncStorage:()=>w,workUnitAsyncStorage:()=>v});var o={};t.r(o),t.d(o,{POST:()=>b,dynamic:()=>p});var s=t(96559),i=t(48088),a=t(37719),n=t(32190),l=t(33873),c=t.n(l),d=t(29021),u=t.n(d);let p="force-dynamic",m=!1,g=null,f=null;function y(){try{let e;let{initializeApp:r,getApps:o}=t(602);return e=o().length?o()[0]:r({apiKey:"AIzaSyB_d5ueTul9vKeNw3pmEtCmbF9w1BVkrAQ",authDomain:"pmd-police-mobile-directory.firebaseapp.com",projectId:"pmd-police-mobile-directory",storageBucket:"pmd-police-mobile-directory.appspot.com"}),console.log("âœ… Firebase Client SDK initialized as fallback"),{success:!0,app:e}}catch(e){return console.error("âŒ Failed to initialize Firebase:",e.message),{success:!1,error:e.message}}}async function b(e){console.log("\uD83D\uDCE5 Gallery Firebase Upload API: Request received");try{let r,o;let{title:s,fileBase64:i,mimeType:a,category:l,description:d,userEmail:p}=await e.json();if(console.log("\uD83D\uDCE5 Upload request:",{title:s||"Untitled",mimeType:a,fileSize:i?`${(3*i.length/4/1024).toFixed(2)} KB`:"unknown"}),!i)return n.NextResponse.json({success:!1,error:"Missing required field: fileBase64"},{status:400});try{r=Buffer.from(i,"base64")}catch(e){return n.NextResponse.json({success:!1,error:"Invalid base64 file data"},{status:400})}if(r.length>5242880)return n.NextResponse.json({success:!1,error:"File too large (max 5MB)"},{status:400});let b=a||"image/jpeg";if(!["image/png","image/jpeg","image/jpg","image/gif","image/webp"].includes(b.toLowerCase()))return n.NextResponse.json({success:!1,error:"Unsupported image type. Allowed: PNG, JPEG, GIF, WEBP"},{status:400});let A=b.split("/")[1]||"jpg",w=`${Date.now()}_${Math.random().toString(36).substring(2,9)}`,v=`gallery/${w}.${A}`,h=function(){if(m)return{success:!0,storage:g,firestore:f};try{let e=t(46675);if(e.apps.length)return m=!0,g=e.storage(),f=e.firestore(),console.log("âœ… Firebase Admin SDK already initialized"),{success:!0,storage:g,firestore:f};try{if(process.env.GOOGLE_APPLICATION_CREDENTIALS){let r=c().isAbsolute(process.env.GOOGLE_APPLICATION_CREDENTIALS)?process.env.GOOGLE_APPLICATION_CREDENTIALS:c().resolve(process.cwd(),process.env.GOOGLE_APPLICATION_CREDENTIALS);if(console.log("\uD83D\uDCC1 Loading service account from:",r),console.log("\uD83D\uDCC1 Current working directory:",process.cwd()),console.log("\uD83D\uDCC1 GOOGLE_APPLICATION_CREDENTIALS:",process.env.GOOGLE_APPLICATION_CREDENTIALS),!u().existsSync(r))throw Error(`Service account file not found at: ${r}`);let t=u().readFileSync(r,"utf8"),o=JSON.parse(t);console.log("\uD83D\uDCE7 Service account email:",o.client_email),console.log("\uD83D\uDCCB Project ID:",o.project_id),e.initializeApp({credential:e.credential.cert(o),storageBucket:"pmd-police-mobile-directory.firebasestorage.app",projectId:"pmd-police-mobile-directory"})}else console.log("âš ï¸ GOOGLE_APPLICATION_CREDENTIALS not set, trying default credentials"),e.initializeApp({storageBucket:"pmd-police-mobile-directory.firebasestorage.app",projectId:"pmd-police-mobile-directory"});return m=!0,g=e.storage(),f=e.firestore(),console.log("âœ… Firebase Admin SDK initialized successfully"),{success:!0,storage:g,firestore:f}}catch(e){return console.warn("âš ï¸ Firebase Admin SDK initialization failed:",e.message),console.warn("âš ï¸ Error code:",e.code),"app/no-app"===e.code&&(console.warn("âš ï¸ This usually means Admin SDK credentials are missing."),console.warn("âš ï¸ For local development, set GOOGLE_APPLICATION_CREDENTIALS env var"),console.warn("âš ï¸ Or use 'gcloud auth application-default login' for ADC")),{success:!1,error:e.message}}}catch(e){return console.warn("âš ï¸ Firebase Admin SDK not available:",e.message),{success:!1,error:e.message}}}();if(h.success&&h.storage)try{console.log("\uD83D\uDCE4 Uploading via Firebase Admin SDK to:",v);let e="pmd-police-mobile-directory.firebasestorage.app";console.log("\uD83D\uDCE6 Using bucket:",e);let t=h.storage.bucket(e);console.log("\uD83D\uDCE6 Bucket object created, attempting to verify access...");try{let[r]=await Promise.race([t.exists(),new Promise((e,r)=>setTimeout(()=>r(Error("Bucket check timeout")),5e3))]);r?console.log("âœ… Bucket verified and accessible:",e):console.warn("âš ï¸ Bucket exists check returned false, but continuing with upload attempt...")}catch(e){console.warn("âš ï¸ Bucket check failed (may be permissions propagation delay):",e.message),console.warn("âš ï¸ Continuing with upload attempt anyway...")}let i=t.file(v);await i.save(r,{metadata:{contentType:b,metadata:{uploadedBy:p||"admin@pmd.com",title:s||"Untitled"}},public:!0}),o=`https://storage.googleapis.com/${t.name}/${v}`,console.log("âœ… Admin SDK upload successful:",o)}catch(e){if(console.error("âŒ Admin SDK upload failed:",e),e.response?.data?.error?.code===404){let r=e.response.data.error.message||e.message;throw Error(`Bucket not found or service account lacks permissions: ${r}

ðŸ’¡ To fix:
1. Go to Firebase Console â†’ Project Settings â†’ Service Accounts
2. Ensure the service account has "Storage Admin" or "Storage Object Admin" role
3. Or go to Google Cloud Console â†’ IAM & Admin â†’ IAM
4. Find the service account email and grant Storage permissions`)}throw Error(`Admin SDK upload failed: ${e.message}`)}else{let e=y();if(e.success&&e.app)try{console.log("\uD83D\uDCE4 Uploading via Firebase Client SDK to:",v);let{getStorage:i,ref:a,uploadBytes:n,getDownloadURL:l}=t(91084),c=i(e.app),d=a(c,v),u=new Uint8Array(r);await n(d,u,{contentType:b,customMetadata:{uploadedBy:p||"admin@pmd.com",title:s||"Untitled"}}),o=await l(d),console.log("âœ… Client SDK upload successful:",o)}catch(r){console.error("âŒ Client SDK upload failed:",r),console.error("âŒ Error code:",r.code),console.error("âŒ Error message:",r.message),console.error("âŒ Error serverResponse:",r.serverResponse),console.error("âŒ Full error:",JSON.stringify(r,Object.getOwnPropertyNames(r),2));let e=`Upload failed: ${r.message||r.code||"Unknown error"}`;throw("storage/unauthorized"===r.code||"storage/unknown"===r.code)&&(e+="\n\n\uD83D\uDCA1 This might be due to Firebase Storage security rules. Please check your Firebase Console > Storage > Rules to ensure uploads to 'gallery/*' are allowed."),Error(e)}else throw Error(`Firebase initialization failed: ${e.error||"Unknown error"}`)}try{if(h.success&&h.firestore){let e=t(46675),r=new Date;await h.firestore.collection("gallery").doc(w).set({title:s||"Untitled",imageUrl:o,category:l||"Gallery",description:d||"",uploadedBy:p||"admin@pmd.com",createdAt:e.firestore.Timestamp.fromDate(r),updatedAt:e.firestore.Timestamp.fromDate(r),storagePath:v}),console.log("âœ… Firestore metadata saved via Admin SDK")}else{let e=y();if(e.success&&e.app){let{getFirestore:r,doc:i,setDoc:a,Timestamp:n}=t(77724),c=r(e.app),u=n.now();await a(i(c,"gallery",w),{title:s||"Untitled",imageUrl:o,category:l||"Gallery",description:d||"",uploadedBy:p||"admin@pmd.com",createdAt:u,updatedAt:u,storagePath:v}),console.log("âœ… Firestore metadata saved via Client SDK")}}}catch(e){console.warn("âš ï¸ Failed to save to Firestore, but file uploaded:",e.message)}return console.log("Gallery Firebase Upload: Successfully uploaded:",s||"Untitled"),console.log("Gallery Firebase Upload: Download URL:",o),n.NextResponse.json({success:!0,url:o,imageUrl:o,title:s||"Untitled",uploader:p||"admin@pmd.com"})}catch(t){console.error("Gallery Firebase Upload: Error uploading image:",t),console.error("Gallery Firebase Upload: Error stack:",t.stack);let e=t.message||"Failed to upload image",r="";return t.message?.includes("Admin SDK")?r="\n\n\uD83D\uDCA1 To fix this:\n1. Download Firebase service account key from Firebase Console\n2. Set GOOGLE_APPLICATION_CREDENTIALS env variable\n3. Restart dev server":t.message?.includes("Client SDK")||"storage/unknown"===t.code||"storage/unauthorized"===t.code?r="\n\n\uD83D\uDCA1 This is likely due to Firebase Storage security rules.\n\nOption 1 (Recommended): Set up Firebase Admin SDK with service account credentials\nOption 2 (Development only): Update Firebase Storage rules to allow uploads":t.message?.includes("Firebase not initialized")&&(r="\n\n\uD83D\uDCA1 Firebase initialization failed. Check server console for details."),n.NextResponse.json({success:!1,error:e+r,errorCode:t.code||"unknown",details:void 0},{status:500})}}let A=new s.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/gallery/upload-firebase/route",pathname:"/api/gallery/upload-firebase",filename:"route",bundlePath:"app/api/gallery/upload-firebase/route"},resolvedPagePath:"C:\\Users\\ravip\\AndroidStudioProjects\\pmd-admin\\app\\api\\gallery\\upload-firebase\\route.ts",nextConfigOutput:"",userland:o}),{workAsyncStorage:w,workUnitAsyncStorage:v,serverHooks:h}=A;function S(){return(0,a.patchFetch)({workAsyncStorage:w,workUnitAsyncStorage:v})}},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[447,580,316],()=>t(94536));module.exports=o})();