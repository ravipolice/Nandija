"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[974],{1138:(e,t,r)=>{let o,a,i,n;r.d(t,{IG:()=>n,db:()=>i,j2:()=>a});var l=r(3915),s=r(5404),c=r(5317),d=r(7505);o=(0,l.Dk)().length?(0,l.Dk)()[0]:(0,l.Wp)({apiKey:"AIzaSyB_d5ueTul9vKeNw3pmEtCmbF9w1BVkrAQ",authDomain:"pmd-police-mobile-directory.firebaseapp.com",projectId:"pmd-police-mobile-directory",storageBucket:"pmd-police-mobile-directory.firebasestorage.app",messagingSenderId:"603972083927",appId:"1:603972083927:web:e4f268aabf3bf3d9f29092"}),a=(0,s.xI)(o),i=(0,c.aU)(o),n=(0,d.c7)(o)},1593:(e,t,r)=>{r.d(t,{Bf:()=>B,Fr:()=>k,Ij:()=>p,Kl:()=>q,OT:()=>F,Oc:()=>g,Qu:()=>f,Rr:()=>H,UI:()=>G,WC:()=>_,XR:()=>x,Y$:()=>y,Yb:()=>A,Z1:()=>U,Zy:()=>w,_Z:()=>v,a1:()=>O,ae:()=>E,bV:()=>m,cM:()=>D,cs:()=>C,eT:()=>T,fb:()=>z,gG:()=>I,getDocumentsList:()=>R,l3:()=>u,oy:()=>J,qB:()=>b,r4:()=>h,sR:()=>N,ui:()=>j,vC:()=>M,wz:()=>S,xb:()=>P});var o=r(5317),a=r(1138);let i=async(e,t)=>{if(!a.db)throw Error("Firestore not initialized (server-side or not available)");return(await (0,o.gS)((0,o.rJ)(a.db,e),{...t,createdAt:o.Dc.now()})).id},n=async(e,t)=>{if(!a.db)return console.warn("Firestore not initialized (server-side or not available)"),null;let r=(0,o.H9)(a.db,e,t),i=await (0,o.x7)(r);return i.exists()?{id:i.id,...i.data()}:null},l=async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];if(!a.db)return console.warn("Firestore not initialized (server-side or not available)"),[];let r=(0,o.P)((0,o.rJ)(a.db,e),...t);return(await (0,o.GG)(r)).docs.map(e=>({id:e.id,...e.data()}))},s=async(e,t,r)=>{if(!a.db)throw Error("Firestore not initialized (server-side or not available)");let i=(0,o.H9)(a.db,e,t);await (0,o.mZ)(i,{...r,updatedAt:o.Dc.now()})},c=async(e,t)=>{if(!a.db)throw Error("Firestore not initialized (server-side or not available)");let r=(0,o.H9)(a.db,e,t);await (0,o.kd)(r)},d=e=>{let t={...e};if(Object.keys(t).forEach(e=>{void 0===t[e]&&delete t[e]}),t.aliases||(t.aliases=[]),t.staffType||(t.staffType="POLICE"),"MINISTERIAL"===t.staffType){var r;t.equivalent_rank=null!==(r=t.equivalent_rank)&&void 0!==r?r:"",t.requiresMetalNumber=!1}return""===t.remarks&&(t.remarks=null),t},g=async()=>{let e=await l("employees",[(0,o.My)("name")]),t=new Map;return e.forEach(e=>{var r;let o=null===(r=e.kgid)||void 0===r?void 0:r.trim().toLowerCase();o&&!t.has(o)?t.set(o,e):o&&console.warn("Duplicate employee found with kgid: ".concat(e.kgid,". Keeping first occurrence."))}),Array.from(t.values()).map(e=>{if(e.photoUrl||e.photoUrlFromGoogle){let t=e.photoUrl||e.photoUrlFromGoogle||"";if(t.includes("drive.google.com")){let r=null,o=t.match(/[?&]id=([-\w]{25,})/);if(o&&(r=o[1]),!r){let e=t.match(/\/file\/d\/([-\w]{25,})/);e&&(r=e[1])}if(r&&!t.includes("lh3.googleusercontent.com"))return{...e,photoUrl:"https://lh3.googleusercontent.com/d/".concat(r),photoUrlFromGoogle:e.photoUrlFromGoogle?"https://lh3.googleusercontent.com/d/".concat(r):void 0}}}return e})},u=async e=>n("employees",e),m=async e=>{let t=e.rank&&e.metalNumber?"".concat(e.rank," ").concat(e.metalNumber):e.rank||void 0;return i("employees",{...e,displayRank:t,createdAt:o.Dc.now(),updatedAt:o.Dc.now()})},y=async(e,t)=>{let r={...t};if(void 0!==t.rank||void 0!==t.metalNumber){var o,a;let i=await u(e),n=null!==(o=t.rank)&&void 0!==o?o:null==i?void 0:i.rank,l=null!==(a=t.metalNumber)&&void 0!==a?a:null==i?void 0:i.metalNumber;r.displayRank=n&&l?"".concat(n," ").concat(l):n||void 0}return s("employees",e,r)},f=async e=>c("employees",e),p=async()=>(await l("officers",[(0,o.My)("name")])).map(e=>({...e,agid:e.agid||e.cfd||void 0})),h=async e=>n("officers",e),w=async e=>i("officers",{...e,createdAt:o.Dc.now()}),v=async(e,t)=>s("officers",e,t),A=async e=>c("officers",e),D=async()=>{try{let e=await l("districts",[]),t=e.filter(e=>!1!==e.isActive).sort((e,t)=>(e.name||"").localeCompare(t.name||""));return t.length>0?t:e.sort((e,t)=>(e.name||"").localeCompare(t.name||""))}catch(e){return console.error("Error fetching districts:",e),[]}},k=async e=>i("districts",{...e,isActive:!0}),b=async(e,t)=>s("districts",e,t),E=async e=>c("districts",e),F=async e=>{try{if(e)try{return await l("stations",[(0,o._M)("district","==",e),(0,o.My)("name")])}catch(t){return console.warn("Error with filtered query, trying client-side filter:",t),(await l("stations",[])).filter(t=>t.district===e).sort((e,t)=>(e.name||"").localeCompare(t.name||""))}else try{return await l("stations",[(0,o.My)("name")])}catch(e){return console.warn("Error with ordered query, trying without order:",e),(await l("stations",[])).sort((e,t)=>(e.name||"").localeCompare(t.name||""))}}catch(e){return console.error("Error fetching stations:",e),[]}},U=async e=>i("stations",{...e,isActive:!0}),_=async(e,t)=>s("stations",e,t),T=async e=>c("stations",e),I=async()=>{try{let e=(await l("rankMaster",[])).map(e=>({...e,rank_id:e.rank_id||e.id||""})),t=e.filter(e=>!1!==e.isActive).sort((e,t)=>void 0!==e.seniority_order&&void 0!==t.seniority_order?e.seniority_order-t.seniority_order:void 0!==e.seniority_order?-1:void 0!==t.seniority_order?1:(e.rank_label||"").localeCompare(t.rank_label||""));return t.length>0?t:e.sort((e,t)=>void 0!==e.seniority_order&&void 0!==t.seniority_order?e.seniority_order-t.seniority_order:(e.rank_label||"").localeCompare(t.rank_label||""))}catch(e){return console.error("Error fetching ranks:",e),[]}},M=async e=>{if(!a.db)throw Error("Firestore not initialized (server-side or not available)");if(!e.rank_id)throw Error("rank_id is required");let t=d(e),r=(0,o.H9)(a.db,"rankMaster",e.rank_id);return await (0,o.BN)(r,{...t,createdAt:o.Dc.now(),updatedAt:o.Dc.now()}),e.rank_id},C=async(e,t)=>{if(!a.db)throw Error("Firestore not initialized (server-side or not available)");let r=(0,o.H9)(a.db,"rankMaster",e),i=d(t);await (0,o.mZ)(r,{...i,updatedAt:o.Dc.now()})},N=async e=>c("rankMaster",e),S=async()=>{try{return await l("pending_registrations",[(0,o.My)("createdAt","desc")])}catch(e){if((null==e?void 0:e.code)==="failed-precondition"){console.warn("Firestore index missing for pending_registrations, fetching without orderBy");try{return await l("pending_registrations",[])}catch(e){return console.error("Error fetching pending registrations (fallback):",e),[]}}return console.error("Error fetching pending registrations:",e),[]}},B=async(e,t)=>{await i("employees",{kgid:t.kgid,name:t.name,email:t.email,mobile1:t.mobile1,mobile2:t.mobile2,rank:t.rank,district:t.district,station:t.station,pin:t.pin,isApproved:!0,isAdmin:!1}),await c("pending_registrations",e)},P=async e=>{await c("pending_registrations",e)},G=async function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return i(t?"admin_notifications":"notifications_queue",{...e,status:"pending",createdAt:o.Dc.now()})},R=async()=>{try{console.log("Fetching documents from Firestore + Apps Script...");let e=[];try{try{if(console.log("\uD83D\uDD0D Fetching documents from Firestore with orderBy('createdAt', 'desc')..."),(e=await l("documents",[(0,o.My)("createdAt","desc")])).length>0)console.log("✅ Found ".concat(e.length," documents in Firestore (with orderBy)")),console.log("✅ Firestore documents sample:",JSON.stringify(e[0],null,2));else{console.log("ℹ️ No documents found in Firestore collection 'documents' (with orderBy)"),console.log("\uD83D\uDD0D Trying without orderBy as fallback...");try{(e=await l("documents",[])).sort((e,t)=>{var r,a;let i=(null===(r=e.createdAt)||void 0===r?void 0:r.toDate)?e.createdAt.toDate().getTime():e.createdAt instanceof o.Dc?e.createdAt.toMillis():0;return((null===(a=t.createdAt)||void 0===a?void 0:a.toDate)?t.createdAt.toDate().getTime():t.createdAt instanceof o.Dc?t.createdAt.toMillis():0)-i}),e.length>0?(console.log("✅ Found ".concat(e.length," documents in Firestore (without orderBy)")),console.log("✅ Firestore documents sample:",JSON.stringify(e[0],null,2))):console.log("ℹ️ No documents found in Firestore collection 'documents' (without orderBy either)")}catch(e){console.error("❌ Error fetching without orderBy:",null==e?void 0:e.message)}}}catch(t){if((null==t?void 0:t.code)==="failed-precondition")console.warn("⚠️ Firestore index missing for 'createdAt', fetching without orderBy..."),(e=await l("documents",[])).sort((e,t)=>{var r,a;let i=(null===(r=e.createdAt)||void 0===r?void 0:r.toDate)?e.createdAt.toDate().getTime():e.createdAt instanceof o.Dc?e.createdAt.toMillis():0;return((null===(a=t.createdAt)||void 0===a?void 0:a.toDate)?t.createdAt.toDate().getTime():t.createdAt instanceof o.Dc?t.createdAt.toMillis():0)-i}),e.length>0?(console.log("✅ Found ".concat(e.length," documents in Firestore (without orderBy)")),console.log("✅ Firestore documents sample:",JSON.stringify(e[0],null,2))):console.log("ℹ️ No documents found in Firestore collection 'documents' (without orderBy)");else throw t}}catch(e){console.error("❌ Error fetching from Firestore:",(null==e?void 0:e.message)||"Unknown"),console.error("❌ Error code:",null==e?void 0:e.code),console.error("❌ Error details:",e)}let t=[];try{console.log("Fetching from Apps Script API via proxy...");let e=await fetch("/api/documents",{method:"GET",headers:{"Content-Type":"application/json"},cache:"no-store"});if(!e.ok)throw Error("HTTP error! status: ".concat(e.status));let r=await e.json();if(console.log("API response type:",Array.isArray(r)?"array":typeof r),console.log("API response length:",Array.isArray(r)?r.length:"not an array"),Array.isArray(r))t=r;else if(r&&"object"==typeof r){r.error&&console.error("API returned error:",r.error);let e=r.data||r.documents||r.items||[];Array.isArray(e)&&(t=e)}}catch(e){console.warn("Error fetching from Apps Script API:",(null==e?void 0:e.message)||e)}let r=new Map,a=function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(t&&(e.fileId||e.id))return"firestore_".concat(e.fileId||e.id);if(!t&&e.fileId)return"gdrive_".concat(e.fileId);let r=e.url||e.URL;if(r){let e=r.includes("storage.googleapis.com")||r.includes("firebasestorage.app")?"firebase":"gdrive";return"".concat(e,"_").concat(r)}return"".concat(t?"firestore":"gdrive","_").concat(e.title||e.name||e.id||Math.random().toString(36).slice(2))};e.forEach(e=>{let t=a(e,!0);r.set(t,e),console.log("\uD83D\uDCE6 Added Firestore doc: ".concat(e.title," (key: ").concat(t,")"))}),t.forEach(e=>{let t=a(e,!1);r.has(t)?console.log("⚠️ Skipped duplicate API doc: ".concat(e.title||e.Title," (key: ").concat(t,")")):(r.set(t,e),console.log("\uD83D\uDCE6 Added API doc: ".concat(e.title||e.Title," (key: ").concat(t,")")))});let i=Array.from(r.values()).map(e=>e.Delete&&"deleted"===e.Delete.toString().toLowerCase()?null:{...e,name:e.name||e.Title||e.title||"Untitled Document",url:e.url||e.URL||"",type:e.type||e.fileType||e.Category||e.category||"",title:e.Title||e.title||e.name,URL:e.URL||e.url,fileType:e.fileType,category:e.Category||e.category,description:e.Description||e.description,uploadedBy:e.UploadedBy||e.uploadedBy,uploadedDate:e.UploadedDate||e.uploadedDate,fileId:e.fileId,createdAt:e.createdAt||(e.UploadedDate?"string"==typeof e.UploadedDate?o.Dc.fromDate(new Date(e.UploadedDate)):e.UploadedDate instanceof Date?o.Dc.fromDate(e.UploadedDate):e.UploadedDate:void 0)}).filter(e=>!!e);return i.sort((e,t)=>{var r,a;let i=(null===(r=e.createdAt)||void 0===r?void 0:r.toDate)?e.createdAt.toDate().getTime():e.createdAt instanceof o.Dc?e.createdAt.toMillis():0;return((null===(a=t.createdAt)||void 0===a?void 0:a.toDate)?t.createdAt.toDate().getTime():t.createdAt instanceof o.Dc?t.createdAt.toMillis():0)-i}),console.log("Returning ".concat(i.length," normalized documents (merged Firestore + Apps Script)")),i}catch(e){return console.error("Error fetching documents:",e),console.error("Error details:",{message:null==e?void 0:e.message,code:null==e?void 0:e.code,stack:null==e?void 0:e.stack}),[]}},j=async e=>i("documents",e),z=async()=>{try{console.log("Fetching gallery images (Firebase + Apps Script)...");let e=[];try{(e=await l("gallery",[])).length>0&&console.log("Found ".concat(e.length," images in Firestore"))}catch(e){console.warn("Error fetching gallery images from Firestore:",(null==e?void 0:e.message)||e)}let t=[];try{console.log("Fetching from Apps Script API via proxy...");let e=await fetch("/api/gallery",{method:"GET",headers:{"Content-Type":"application/json"},cache:"no-store"});if(e.ok){let r=await e.json();if(console.log("Gallery API response type:",Array.isArray(r)?"array":typeof r),console.log("Gallery API response length:",Array.isArray(r)?r.length:"not an array"),r&&"object"==typeof r&&!Array.isArray(r)){if(r.error)console.error("Gallery API returned error:",r.error);else{let e=r.data||r.images||r.items||[];Array.isArray(e)&&e.length>0&&(t=L(e))}}else Array.isArray(r)?t=L(r):console.warn("Gallery API response is not an array or object with data")}else console.error("Gallery API HTTP error:",e.status)}catch(e){console.warn("Error fetching gallery images from Apps Script:",(null==e?void 0:e.message)||e)}let r=new Map;e.forEach(e=>{e.imageUrl&&r.set(e.imageUrl,e)}),t.forEach(e=>{e.imageUrl&&!r.has(e.imageUrl)&&r.set(e.imageUrl,e)});let o=Array.from(r.values());return o.sort((e,t)=>{var r,o;let a=(null===(r=e.createdAt)||void 0===r?void 0:r.toDate)?e.createdAt.toDate().getTime():0;return((null===(o=t.createdAt)||void 0===o?void 0:o.toDate)?t.createdAt.toDate().getTime():0)-a}),console.log("Returning ".concat(o.length," gallery images (merged)")),o}catch(e){return console.error("Error fetching gallery images:",e),[]}};function L(e){if(!e||0===e.length)return[];console.log("Processing ".concat(e.length," gallery images...")),e.length>0&&console.log("First raw image before normalization:",JSON.stringify(e[0],null,2));let t=e.map(e=>{let t;let r=e.Delete||e.delete||e.Delete||(void 0!==e[6]?e[6]:null);if(r&&"deleted"===r.toString().toLowerCase())return null;let a=e.imageUrl||e.URL||e.url||e.URL||e.image||"";if(!a||""===a.trim())return console.warn("Skipping image with no URL:",e),null;if(a.includes("drive.google.com/uc")){let e=null,t=a.match(/\/uc\?id=([-\w]{25,})/);if(t&&(e=t[1]),!e){let t=a.match(/\/uc\?export=view&id=([-\w]{25,})/);t&&(e=t[1])}if(!e){let t=a.match(/\/file\/d\/([-\w]{25,})/);t&&(e=t[1])}e&&(a="https://lh3.googleusercontent.com/d/".concat(e))}let i=e.uploadedDate||e.UploadedDate||e["Uploaded Date"]||e.createdAt||e.UploadedDate||e.date;if(i)try{if(i instanceof Date)t=o.Dc.fromDate(i);else if("string"==typeof i){let e=new Date(i);isNaN(e.getTime())||(t=o.Dc.fromDate(e))}else i.toDate&&(t=i)}catch(e){console.warn("Could not parse date:",i,e)}let n=e.title||e.Title||e.Title||e.title||"",l={imageUrl:a,title:n,id:e.id||n||"img-".concat(Date.now(),"-").concat(Math.random()),createdAt:t};return l.imageUrl||console.warn("Normalized image missing imageUrl:",l),l}).filter(e=>!!(e&&e.imageUrl&&""!==e.imageUrl.trim()));return t.sort((e,t)=>{var r,o;let a=(null===(r=e.createdAt)||void 0===r?void 0:r.toDate)?e.createdAt.toDate().getTime():0;return((null===(o=t.createdAt)||void 0===o?void 0:o.toDate)?t.createdAt.toDate().getTime():0)-a}),console.log("Returning ".concat(t.length," normalized gallery images")),t}let O=async e=>i("gallery",e),x=async(e,t)=>{try{let r=await fetch("/api/gallery/delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:e,userEmail:t})});if(!r.ok){let e=await r.json().catch(()=>({error:"Unknown error"}));throw Error(e.error||"Failed to delete image: ".concat(r.status))}let o=await r.json();if(!o.success)throw Error(o.error||"Failed to delete image")}catch(e){throw console.error("Error deleting gallery image:",e),Error("Failed to delete gallery image: ".concat((null==e?void 0:e.message)||"Unknown error"))}},q=async()=>l("useful_links",[(0,o.My)("name")]),H=async e=>i("useful_links",e),J=async()=>{let e=await g(),t=await D(),r=await F(),o={},a={},i={};return e.forEach(e=>{e.district&&(o[e.district]=(o[e.district]||0)+1),e.station&&(a[e.station]=(a[e.station]||0)+1),e.rank&&(i[e.rank]=(i[e.rank]||0)+1)}),{total:e.length,approved:e.filter(e=>e.isApproved).length,pending:e.filter(e=>!e.isApproved).length,byDistrict:o,byStation:a,byRank:i,districtsCount:t.length,stationsCount:r.length}}}}]);